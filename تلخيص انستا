// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”— Ù†Ø¸Ø§Ù… Ø§Ø³ØªØ®Ù„Ø§Øµ Ø±ÙˆØ§Ø¨Ø· InstaPay Ø§Ù„Ø°ÙƒÙŠ - Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„ÙÙˆØ±ÙŠ Ù„Ø±ÙˆØ§Ø¨Ø· InstaPay
function validateInstapayInput(input) {
    const text = input.value.trim();
    const container = input.closest('.form-group');
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    const existingPreview = container.querySelector('.instapay-preview');
    if (existingPreview) {
        existingPreview.remove();
    }
    
    if (!text) {
        updateValidationUI(input, true, '');
        return true;
    }
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ø±Ø§Ø¨Ø·
    const extractedLink = extractInstapayLink(text);
    
    if (extractedLink) {
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
        createInstapayPreview(container, extractedLink, text);
        updateValidationUI(input, true, 'âœ“ ØªÙ… Ø§Ø³ØªØ®Ù„Ø§Øµ Ø±Ø§Ø¨Ø· InstaPay');
        return true;
    } else {
        updateValidationUI(input, false, 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· InstaPay ØµØ­ÙŠØ­');
        return false;
    }
}

// Ø§Ø³ØªØ®Ù„Ø§Øµ Ø±Ø§Ø¨Ø· InstaPay Ù…Ù† Ø§Ù„Ù†Øµ (JavaScript)
function extractInstapayLink(text) {
    const patterns = [
        /https?:\/\/(?:www\.)?ipn\.eg\/S\/[^\/\s]+\/instapay\/[A-Za-z0-9]+/gi,
        /https?:\/\/(?:www\.)?instapay\.com\.eg\/[^\s<>"{}|\\^`\[\]]+/gi,
        /https?:\/\/(?:www\.)?app\.instapay\.com\.eg\/[^\s<>"{}|\\^`\[\]]+/gi,
        /https?:\/\/(?:www\.)?instapay\.app\/[^\s<>"{}|\\^`\[\]]+/gi,
        /https?:\/\/(?:www\.)?ipn\.eg\/[^\s<>"{}|\\^`\[\]]+/gi,
    ];
    
    for (const pattern of patterns) {
        const matches = text.match(pattern);
        if (matches && matches.length > 0) {
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
            let link = matches[0].replace(/[.,;!?]+$/, '');
            if (isValidInstapayUrl(link)) {
                return link;
            }
        }
    }
    
    return null;
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ø§Ø¨Ø· InstaPay (JavaScript)
function isValidInstapayUrl(url) {
    if (!url || (!url.startsWith('http://') && !url.startsWith('https://'))) {
        return false;
    }
    
    const validDomains = ['ipn.eg', 'instapay.com.eg', 'app.instapay.com.eg', 'instapay.app'];
    const lowerUrl = url.toLowerCase();
    
    return validDomains.some(domain => lowerUrl.includes(domain)) && url.length >= 20;
}

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ
function createInstapayPreview(container, extractedLink, originalText) {
    const previewDiv = document.createElement('div');
    previewDiv.className = 'instapay-preview';
    
    previewDiv.innerHTML = `
        <div class="preview-header">
            <i class="fas fa-link"></i>
            <span>ØªÙ… Ø§Ø³ØªØ®Ù„Ø§Øµ Ø±Ø§Ø¨Ø· InstaPay</span>
        </div>
        <div class="extracted-link">
            <div class="link-label">Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ:</div>
            <div class="link-url">${extractedLink}</div>
        </div>
        <div class="preview-actions">
            <button type="button" class="test-link-btn" onclick="testInstapayLink('${extractedLink}')">
                <i class="fas fa-external-link-alt"></i>
                Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø§Ø¨Ø·
            </button>
            <button type="button" class="copy-link-btn" onclick="copyInstapayLink('${extractedLink}')">
                <i class="fas fa-copy"></i>
                Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
            </button>
        </div>
    `;
    
    container.appendChild(previewDiv);
    
    // Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø¸Ù‡ÙˆØ±
    setTimeout(() => {
        previewDiv.classList.add('show');
    }, 100);
}

// Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø§Ø¨Ø· InstaPay
function testInstapayLink(url) {
    window.open(url, '_blank');
    showNotification('ØªÙ… ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯', 'info');
}

// Ù†Ø³Ø® Ø±Ø§Ø¨Ø· InstaPay
async function copyInstapayLink(url) {
    try {
        if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(url);
        } else {
            // Ø·Ø±ÙŠÙ‚Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            const textArea = document.createElement('textarea');
            textArea.value = url;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        }
        
        showNotification('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        
        if (navigator.vibrate) {
            navigator.vibrate([50, 50, 50]);
        }
        
    } catch (error) {
        showNotification('ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·', 'error');
    }
}

// ØªØ­Ø¯ÙŠØ« Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ù‚Ù„ InstaPay
function initializeInstapayListener() {
    const instapayInput = document.getElementById('payment-link');
    if (instapayInput) {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰
        instapayInput.removeEventListener('input', validateInstapayInput);
        instapayInput.removeEventListener('paste', validateInstapayInput);
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯
        instapayInput.addEventListener('input', function() {
            validateInstapayInput(this);
        });
        
        instapayInput.addEventListener('paste', function() {
            // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ù„ØµÙ‚ Ø§Ù„Ù†Øµ
            setTimeout(() => {
                validateInstapayInput(this);
            }, 100);
        });
        
        console.log('ğŸ”— InstaPay input listener initialized');
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© setupDynamicInputs Ù„ØªØ´Ù…Ù„ InstaPay
const originalSetupDynamicInputs = setupDynamicInputs;
setupDynamicInputs = function() {
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
    originalSetupDynamicInputs();
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ InstaPay
    initializeInstapayListener();
};

// Ø¥Ø¶Ø§ÙØ© ØªØ­Ø¯ÙŠØ« validatePaymentInput Ù„Ø¯Ø¹Ù… Ø§Ø³ØªØ®Ù„Ø§Øµ InstaPay
const originalValidatePaymentInput = validatePaymentInput;
validatePaymentInput = function(input) {
    const value = input.value.trim();
    const inputId = input.id;
    let isValid = false;
    let errorMessage = '';
    
    if (!value) {
        updateValidationUI(input, true, '');
        return true;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© (11 Ø±Ù‚Ù…)
    if (['vodafone_cash', 'etisalat_cash', 'orange_cash', 'we_pay', 
         'fawry', 'aman', 'masary', 'bee', 'mobile-number'].includes(inputId)) {
        isValid = /^01[0125][0-9]{8}$/.test(value) && value.length === 11;
        errorMessage = isValid ? '' : 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ 010ØŒ 011ØŒ 012ØŒ Ø£Ùˆ 015';
    }
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒØ§Ø±Øª ØªÙŠÙ„Ø¯Ø§ (16 Ø±Ù‚Ù…)
    else if (['telda_card', 'card-number'].includes(inputId)) {
        const numbersOnly = value.replace(/\s/g, '');
        isValid = /^\d{16}$/.test(numbersOnly);
        errorMessage = isValid ? '' : 'Ø±Ù‚Ù… ÙƒØ§Ø±Øª ØªÙŠÙ„Ø¯Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 16 Ø±Ù‚Ù…';
    }
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø§Ø¨Ø· Ø¥Ù†Ø³ØªØ§ Ø¨Ø§ÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
    else if (['instapay_link', 'payment-link'].includes(inputId)) {
        const extractedLink = extractInstapayLink(value);
        isValid = !!extractedLink;
        errorMessage = isValid ? '' : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· InstaPay ØµØ­ÙŠØ­';
        
        // ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ù‚Ù„ Ù„Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ
        if (isValid && extractedLink !== value) {
            input.value = extractedLink;
        }
    }
    
    updateValidationUI(input, isValid, errorMessage);
    return isValid;
};

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© isValidInstaPayLink Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
isValidInstaPayLink = function(link) {
    return !!extractInstapayLink(link);
};

console.log('ğŸš€ InstaPay Smart Link Extraction System - Initialized');
